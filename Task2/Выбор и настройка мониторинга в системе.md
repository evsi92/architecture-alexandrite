# Мотивация

Необходимо добавить мониторинг в системы, чтобы проактивно реагировать на возникающие проблемы в системе.  
Например, падение компонента или базы данных, критическое повышение параметров, которые требуют контроля человеком. 
И клиенты, и операторы регулярно жалуются на проблемы с производительностью системы. 

Клиенты вовремя не получают своих заказов.  
Встроенный мониторинг позволит отслеживать такие параметры, как загруженность, насыщенность компонента, нагрузку процессора.
Тогда, в зависимости от настроенных правил, новый экземпляр может быть развернут, чтобы обработать больший объем данных. 
Мониторинг позволит отслеживать количество и процент происходящих ошибок.  

Операторы жалуются на невозможность работы с бордом для получения актуальных новых заказов.  
Здесь имеет смысл отслеживать системные параметры базы данных, а также время выполнения запросов на базу данных, время отклика системы, 
длительность ответа по запросам. 
Улучшение производительности и проактивный мониторинг деградации позволит увеличить скорость выполнения заказов, а значит прибыль компании. 

# Выбор подхода к мониторингу 

В силу того, что внедрение мониторинга - новая и неизвестная задача для дев команды, а значит дорогостоящая, 
имеет смысл внедрить мониторинг в наиболее критичные участки флоу.  
- Мониторинг сервиса калькуляции (Calculation Service на схеме). Имеет смысл использовать USE подход, т.к. покажет 
наиболее полезные нам параметры для этой части флоу (утилизация, насыщенность и ошибки)
- Мониторинг MES API. Имеет смысл использовать RED подход, т.к. MES API предоставляет операторам данные для работы и 
взаимодействует с базой данных. Подход как раз предлагает мониторить частоту запросов, их длительности и ошибки. 
На производительность этого сервиса уже есть жалобы, поэтому его необходимо мониторить в первую очередь. 

| Метрика                                            | Зачем нужна                                | Ярлыки                        |
|----------------------------------------------------|--------------------------------------------|-------------------------------|
| Number of dead-letter-exchange letters in RabbitMQ | Чтобы отследить отбракованные сообщения    | queue, tenant_id, order_id    |
| CPU % for Calculation Service                      | Позволит оценить текущее состояние сервиса | instance                      |
| Memory Utilisation for Calculation Service         | Контроль ресурсов                          | instance                      |
| CPU % for MES API                                  | Позволит оценить текущее состояние сервиса | instance                      |
| Memory Utilisation for MES API                     | Контроль ресурсов                          | instance                      |
| Memory Utilisation for MES db instance             | Контроль ресурсов на БД                    | db_instance                   |
| Number of connections for MES db instance          | Проверка пула соединений                   | db_instance                   |
| Response time (latency) for MES API                | Время обработки запроса                    | endpoint, method, status_code |
| Number of requests (RPS) for MES API               | Позволит оценить нагрузку от пользователей | endpoint, method, tenant      |
| Number of HTTP 200 for MES API                     | Количество успешных запросов               | endpoint, method              |
| Number of HTTP 500 for MES API                     | Количество неуспешных запросов             | endpoint, method              |


# План действий

Для имплементации обоих методов мониторинга (RED & USE) нам подойдет Prometheus + Grafana.
1. Добавить создание и настройку Prometheus в docker-compose
2. Разработать новый endpoint на MES API для сбора статистики по RED модели
3. Разработать новый endpoint на Calculation Service для сбора статистики по USE модели
4. Подключить RabbitMQ Exporter для сбора статистики на очередях
5. Добавить создание и настройку Grafana в docker-compose
6. Создать дашборды и алертинг в Grafana

