# Мотивация
На данный момент выделены 2 проблемы производительности: 
- Новые клиенты жалуются на скорость выполнения заказов. Для кардинального решения этой проблемы необходимы трейсы и мониторинг систем, 
тогда уже можно будет понять, где именно проблема. В первой части из MES уже была выделена часть для расчета стоимости 
изделия. Предполагается, что задержки и нерациональное использование ресурсов тормозили процесс над изделиями. Тк оператор 
не может начать работу над заказом без расчета, оплаты и подтверждения. Разделение реальной MES части и калькуляции должно 
улучшить и скорость обработки заказов в целом, и производительность MES UI + API. 
- Операторы жалуются на "низкую скорость работы со страницей", а также упоминалось ранее, что сложно искать новые заказы. 
MES уже был трансформирован, но можно еще увеличить скорость работы с ним за счет кеширование. Чтобы операторы не тратили время 
на медленно-работающий интерфейс, а занимались изготовлением изделий более продуктивно. Если увеличить скорость доступа к данным
  (и на чтение 3д файлов из S3, и из базы для поиска заказов в нужной стадии; и на запись: обновить статус заказа), то 
операторы смогут сосредоточиться на своей работе, те прибыль компании возрастет.  
Серверный кеш можно поставить между MES API и MES DB. Клиентский кеш имеет смысл настроить для тяжелых 3Д документов из S3.

# Предлагаемое решение
Можно использовать 2 вида кеширования для разных целей в системе

## Клиентское кеширование. Известно, что пользователь создает свою модель украшения, его стоимость просчитывается, заказ оплачивается. 
Затем заказ поступает оператору для изготовления. Т.е. модель не меняется с момента оплаты и подтверждения. Предполагается, что 
изделие может изготавливаться несколько дней, соответственно имеет смысл загрузить файлик из S3 закешировать его на стороне 
браузера оператора, пока статус заказа не изменится. Это увеличит скорость доступа оператора к заказу, с которым он работает 
в данный момент, а также снизит объем данных передаваемых по сети и нагрузку на сервера. 

Можно использовать Service Worker с Cache Storage, а инвалидировать кеш по изменению статуса заказа. 

## Серверное кеширование между MES API и MES DB 
Предложение, чтобы в кеше всегда были "актуальные" заказы, т.е. те, которое уже Approved, но не Shipped. 
То есть нас интересует определенный промежуток жизни заказа: с момента, когда его заберет себе оператор в работу до момента отправки 
заказа клиенту (далее, MES не заинтересован в статусах, те роль MES выполнена).
Так как наша цель не единая запись, которую мы запрашиваем из базы, а цель - отрисовать борд с заказами по статусам, то 
наиболее подходящим подходом будет использовать Refresh Ahead. 
Когда UI запрашивает страницу с заказами, API обращается в кеш и получает сразу все актуальные заказы, которые были туда 
помещены асинхронно. Тоже самое, когда оператор назначает заказ на себя и запрашивает уже конкретную запись, она уже имеется в кеше. 

Cache-Aside сработает хорошо для обращений уже к конкретным заказам. Нас же интересует сразу пачка заказов в определенных 
статусах. Тоже самое с Read Through. Он не даст преимуществ в отображении борда с заказами.

![](filling%20cache.png)
![](get%20orders.png)

# Инвалидация кеша 
В данном варианте лучше решением будет Event Driven инвалидация по статусу. То есть инвалидация будет завязана на бизнес логике. 
Запись о заказе попадает в кеш, когда MES API получает сообщение с данными о заказе и у заказа статус Approved. 
Далее, необходимо изменить данные, когда статус заказа изменился, например Оператор начал работу или закончил и т.д.
Запись полностью удаляется из кеша, когда статус заказа перешел в Shipped. 

Остальные виды инвалидации не будут столь эффективны, тк точно не известно время выполнения заказа, например. В данном случае, 
большей частью с заказами происходят операции чтения, редко записи. 
